{% extends 'base.html' %}
{% load static %}

<!-- Page title -->
{% block title %}My Bookings - Portuguese Kitchen{% endblock %}

<!-- My Bookings page content -->
{% block content %}

<!-- Hero Section -->
<section class="bookings-hero py-5">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-4 text-center mb-4 mb-lg-0">
        <div class="portuguese-kitchen-logo">
          <img src="{% static 'images/logo-v-3.png' %}" 
     alt="Portuguese Kitchen logo"
     class="hero-logo">
        </div>
      </div>
      <div class="col-lg-8">
        <h2 class="display-5 fw-bold mb-3">Your Reservations</h2>
        <p class="lead mb-0">
          Manage your upcoming bookings and view your dining history
        </p>
      </div>
    </div>
  </div>
</section>

<!-- Bookings Content Section -->
<section class="bookings-content py-5">
  <div class="container">
    
    <!-- Upcoming Bookings -->
    <div class="row mb-5">
      <div class="col-12">
        <div class="section-header d-flex justify-content-between align-items-center mb-4">
          <h3 class="mb-0">
            <i class="bi bi-calendar-event me-2 text-primary"></i>
            Upcoming Bookings
          </h3>
          <a href="{% url 'bookings:booking' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>
            New Booking
          </a>
        </div>

        {% if upcoming_bookings %}
          <div class="row g-4">
            {% for booking in upcoming_bookings %}
            <div class="col-md-6 col-lg-4">
              <div class="booking-card h-100">
                <!-- Card Header -->
                <div class="card-header">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h5 class="mb-1">{{ booking.booking_date|date:"D, M j" }}</h5>
                      <p class="mb-0 text-muted">{{ booking.booking_date|date:"Y" }}</p>
                    </div>
                    <span class="badge bg-status-{{ booking.status|lower }}">
                      {{ booking.status }}
                    </span>
                  </div>
                </div>

                <!-- Card Body -->
                <div class="card-body">
                  <!-- Reference Number -->
                  <div class="booking-detail mb-3">
                    <i class="bi bi-hash text-primary me-2"></i>
                    <small class="text-muted">Reference:</small>
                    <strong class="ms-1">{{ booking.reference_number }}</strong>
                  </div>

                  <!-- Time -->
                  <div class="booking-detail mb-2">
                    <i class="bi bi-clock text-primary me-2"></i>
                    <span>{{ booking.timeslot.time|time:"g:i A" }}</span>
                  </div>

                  <!-- Guests -->
                  <div class="booking-detail mb-2">
                    <i class="bi bi-people text-primary me-2"></i>
                    <span>{{ booking.number_of_guests }} {{ booking.number_of_guests|pluralize:"Guest,Guests" }}</span>
                  </div>

                  <!-- Special Requests -->
                  {% if booking.special_requests %}
                  <div class="booking-detail mb-2">
                    <i class="bi bi-chat-text text-primary me-2"></i>
                    <small class="text-muted">{{ booking.special_requests|truncatewords:10 }}</small>
                  </div>
                  {% endif %}
                </div>

                <!-- Card Footer -->
                <div class="card-footer">
                  <div class="d-grid gap-2">
                    <!-- View Details Button -->
                    <a href="{% url 'bookings:confirmation' booking.reference_number %}" class="btn btn-outline-primary btn-sm">
                      <i class="bi bi-eye me-1"></i>
                      View Details
                    </a>
                    
                    <!-- Edit and Cancel Buttons -->
                    <div class="btn-group" role="group">
                      <a href="{% url 'bookings:edit_booking' booking.reference_number %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-pencil me-1"></i>
                        Edit
                      </a>
                      <button 
                        type="button" 
                        class="btn btn-outline-danger btn-sm" 
                        onclick="confirmCancel('{{ booking.reference_number }}', '{{ booking.booking_date|date:"M j, Y" }}', '{{ booking.timeslot.time|time:"g:i A" }}')"
                      >
                        <i class="bi bi-x-circle me-1"></i>
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <!-- Empty State -->
          <div class="empty-state text-center py-5">
            <i class="bi bi-calendar-x display-1 text-muted mb-4"></i>
            <h4 class="mb-3">No Upcoming Bookings</h4>
            <p class="text-muted mb-4">
              You don't have any upcoming reservations. Book a table to experience authentic Portuguese cuisine!
            </p>
            <a href="{% url 'bookings:booking' %}" class="btn btn-primary btn-lg">
              <i class="bi bi-calendar-plus me-2"></i>
              Book a Table Now
            </a>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Past Bookings -->
    {% if past_bookings %}
    <div class="row">
      <div class="col-12">
        <div class="section-header mb-4">
          <h3 class="mb-0">
            <i class="bi bi-clock-history me-2 text-primary"></i>
            Past Bookings
          </h3>
        </div>

        <!-- Accordion for Past Bookings -->
        <div class="accordion" id="pastBookingsAccordion">
          {% for booking in past_bookings %}
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading{{ forloop.counter }}">
              <button class="accordion-button {% if forloop.counter > 1 %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="{% if forloop.counter == 1 %}true{% else %}false{% endif %}" aria-controls="collapse{{ forloop.counter }}">
                <div class="w-100 d-flex justify-content-between align-items-center pe-3">
                  <div>
                    <strong>{{ booking.booking_date|date:"l, F j, Y" }}</strong>
                    <span class="text-muted ms-3">{{ booking.timeslot.time|time:"g:i A" }}</span>
                    <span class="text-muted ms-3">{{ booking.number_of_guests }} {{ booking.number_of_guests|pluralize:"guest,guests" }}</span>
                  </div>
                  <span class="badge bg-secondary">{{ booking.status }}</span>
                </div>
              </button>
            </h2>
            <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.counter == 1 %}show{% endif %}" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#pastBookingsAccordion">
              <div class="accordion-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <p class="mb-2">
                      <i class="bi bi-hash text-primary me-2"></i>
                      <strong>Reference:</strong> {{ booking.reference_number }}
                    </p>
                    <p class="mb-2">
                      <i class="bi bi-calendar3 text-primary me-2"></i>
                      <strong>Date:</strong> {{ booking.booking_date|date:"F j, Y" }}
                    </p>
                    <p class="mb-2">
                      <i class="bi bi-clock text-primary me-2"></i>
                      <strong>Time:</strong> {{ booking.timeslot.time|time:"g:i A" }}
                    </p>
                  </div>
                  <div class="col-md-6">
                    <p class="mb-2">
                      <i class="bi bi-people text-primary me-2"></i>
                      <strong>Guests:</strong> {{ booking.number_of_guests }}
                    </p>
                    <p class="mb-2">
                      <i class="bi bi-info-circle text-primary me-2"></i>
                      <strong>Status:</strong> <span class="badge bg-secondary">{{ booking.status }}</span>
                    </p>
                    {% if booking.special_requests %}
                    <p class="mb-2">
                      <i class="bi bi-chat-text text-primary me-2"></i>
                      <strong>Requests:</strong> {{ booking.special_requests }}
                    </p>
                    {% endif %}
                  </div>
                </div>
                <div class="mt-3">
                  <a href="{% url 'bookings:confirmation' booking.reference_number %}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-eye me-1"></i>
                    View Full Details
                  </a>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

  </div>
</section>

<!-- Cancel Confirmation Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="cancelModalLabel">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Cancel Booking
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Are you sure you want to cancel this booking?</p>
        <div class="alert alert-warning">
          <strong>Booking Details:</strong><br>
          Reference: <span id="modalReference"></span><br>
          Date: <span id="modalDate"></span><br>
          Time: <span id="modalTime"></span>
        </div>
        <p class="text-danger mb-0">
          <strong>Warning:</strong> This action cannot be undone.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-2"></i>
          Keep Booking
        </button>
        <form id="cancelForm" method="POST" style="display: inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash me-2"></i>
            Yes, Cancel Booking
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

<!-- Extra CSS -->
{% block extra_css %}
<style>
  /* Portuguese Kitchen Logo */
  .portuguese-kitchen-logo {
    padding: 1rem;
  }

  .portuguese-kitchen-logo h3 {
    font-family: var(--font-heading);
    color: var(--espresso-brown);
    line-height: 1.3;
    font-size: 1.5rem;
  }

  .portuguese-kitchen-logo i {
    color: var(--azulejo-blue);
  }

  /* Bookings Hero */
  .bookings-hero {
    border-bottom: 3px solid var(--olive-green);
  }

  /* Bookings Content Section */
  .bookings-content {
    background-color: transparent;
    min-height: 60vh;
  }

  /* Section Headers */
  .section-header h3 {
    color: var(--azulejo-blue);
    font-family: var(--font-heading);
  }

  /* Booking Cards */
  .booking-card {
    background: var(--porcelain-white);
    border: 1px solid #dee2e6;
    border-radius: 10px;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .booking-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  }

  .booking-card .card-header {
    background: linear-gradient(135deg, var(--azulejo-blue) 0%, var(--olive-green) 100%);
    color: white;
    padding: 1.25rem;
    border-bottom: none;
  }

  .booking-card .card-header h5 {
    font-family: var(--font-heading);
    font-size: 1.25rem;
  }

  .booking-card .card-body {
    padding: 1.5rem;
  }

  .booking-card .card-footer {
    background-color: #f8f9fa;
    padding: 1rem 1.5rem;
    border-top: 1px solid #dee2e6;
  }

  /* Booking Details */
  .booking-detail {
    display: flex;
    align-items: center;
    font-size: 0.95rem;
  }

  .booking-detail i {
    font-size: 1.1rem;
    width: 20px;
  }

  /* Status Badges */
  .badge {
    font-weight: 600;
    padding: 0.4rem 0.8rem;
    font-size: 0.75rem;
  }

  .bg-status-pending {
    background-color: var(--olive-green) !important;
  }

  .bg-status-confirmed {
    background-color: #28a745 !important;
  }

  .bg-status-cancelled {
    background-color: var(--terracotta-red) !important;
  }

  .bg-status-completed {
    background-color: #6c757d !important;
  }

  /* Buttons */
  .btn-primary {
    background-color: var(--terracotta-red);
    border-color: var(--terracotta-red);
    font-weight: 600;
  }

  .btn-primary:hover {
    background-color: #a83829;
    border-color: #a83829;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }

  .btn-outline-primary {
    color: var(--azulejo-blue);
    border-color: var(--azulejo-blue);
    font-weight: 600;
  }

  .btn-outline-primary:hover {
    background-color: var(--azulejo-blue);
    border-color: var(--azulejo-blue);
    color: white;
  }

  .btn-outline-secondary {
    color: var(--espresso-brown);
    border-color: var(--espresso-brown);
  }

  .btn-outline-secondary:hover {
    background-color: var(--espresso-brown);
    border-color: var(--espresso-brown);
    color: white;
  }

  .btn-outline-danger {
    color: var(--terracotta-red);
    border-color: var(--terracotta-red);
  }

  .btn-outline-danger:hover {
    background-color: var(--terracotta-red);
    border-color: var(--terracotta-red);
    color: white;
  }

  /* Empty State */
  .empty-state {
    background-color: var(--porcelain-white);
    border-radius: 10px;
    padding: 3rem 2rem;
  }

  .empty-state i {
    opacity: 0.5;
  }

  /* Accordion (Past Bookings) */
  .accordion-item {
    border: 1px solid #dee2e6;
    margin-bottom: 0.5rem;
    border-radius: 5px;
    overflow: hidden;
  }

  .accordion-button {
    background-color: var(--porcelain-white);
    color: var(--espresso-brown);
    font-weight: 500;
  }

  .accordion-button:not(.collapsed) {
    background-color: #f8f9fa;
    color: var(--azulejo-blue);
    box-shadow: none;
  }

  .accordion-button:focus {
    box-shadow: none;
    border-color: var(--azulejo-blue);
  }

  .accordion-body {
    background-color: var(--porcelain-white);
  }

  /* Modal */
  .modal-header.bg-danger {
    background-color: var(--terracotta-red) !important;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .portuguese-kitchen-logo h3 {
      font-size: 1.25rem;
    }

    .display-5 {
      font-size: 2rem;
    }

    .booking-card .card-header h5 {
      font-size: 1.1rem;
    }

    .section-header {
      flex-direction: column;
      gap: 1rem;
    }

    .section-header .btn {
      width: 100%;
    }
  }
</style>
{% endblock %}

<!-- Extra JavaScript -->
{% block extra_js %}
<script>
// Cancel booking confirmation
function confirmCancel(reference, date, time) {
  // Set modal content
  document.getElementById('modalReference').textContent = reference;
  document.getElementById('modalDate').textContent = date;
  document.getElementById('modalTime').textContent = time;
  
  // Set form action
  const form = document.getElementById('cancelForm');
  form.action = "{% url 'bookings:cancel_booking' 'PLACEHOLDER' %}".replace('PLACEHOLDER', reference);
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
  modal.show();
}
</script>
{% endblock %}